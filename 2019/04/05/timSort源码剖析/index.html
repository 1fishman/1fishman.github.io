<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh_CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="TimSorttimsort是jdk自带的一种特别高效的排序算法,大致思想使用的是归并排序,但是内部细节做了许多的优化.在timsort中,主要是为待排序数组分为很多个run块,通过讲这些run块进行归并排序.最后实现总体排序.每个run块的大小为16-32大小.优化地方:   当待排序数组长度小于32就使用二分排序算法 分为多个run块,在通过把run块的起始位置和长度压入栈中,在进行合并. 在">
<meta name="keywords" content="java,源码">
<meta property="og:type" content="article">
<meta property="og:title" content="timSort源码剖析">
<meta property="og:url" content="http://yoursite.com/2019/04/05/timSort源码剖析/index.html">
<meta property="og:site_name" content="fishman的博客">
<meta property="og:description" content="TimSorttimsort是jdk自带的一种特别高效的排序算法,大致思想使用的是归并排序,但是内部细节做了许多的优化.在timsort中,主要是为待排序数组分为很多个run块,通过讲这些run块进行归并排序.最后实现总体排序.每个run块的大小为16-32大小.优化地方:   当待排序数组长度小于32就使用二分排序算法 分为多个run块,在通过把run块的起始位置和长度压入栈中,在进行合并. 在">
<meta property="og:locale" content="zh_CN">
<meta property="og:updated_time" content="2019-04-06T12:24:30.548Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="timSort源码剖析">
<meta name="twitter:description" content="TimSorttimsort是jdk自带的一种特别高效的排序算法,大致思想使用的是归并排序,但是内部细节做了许多的优化.在timsort中,主要是为待排序数组分为很多个run块,通过讲这些run块进行归并排序.最后实现总体排序.每个run块的大小为16-32大小.优化地方:   当待排序数组长度小于32就使用二分排序算法 分为多个run块,在通过把run块的起始位置和长度压入栈中,在进行合并. 在">



  <link rel="alternate" href="/atom.xml" title="fishman的博客" type="application/atom+xml">



  
  
  <link rel="canonical" href="http://yoursite.com/2019/04/05/timSort源码剖析/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>timSort源码剖析 | fishman的博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh_CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">fishman的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/05/timSort源码剖析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fishman">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/image/myavatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fishman的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">timSort源码剖析

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-05 15:52:46" itemprop="dateCreated datePublished" datetime="2019-04-05T15:52:46+08:00">2019-04-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-04-06 20:24:30" itemprop="dateModified" datetime="2019-04-06T20:24:30+08:00">2019-04-06</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/源码阅读/" itemprop="url" rel="index"><span itemprop="name">源码阅读</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             Views:  
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="TimSort"><a href="#TimSort" class="headerlink" title="TimSort"></a>TimSort</h1><p>timsort是jdk自带的一种特别高效的排序算法,大致思想使用的是归并排序,但是内部细节做了许多的优化.<br>在timsort中,主要是为待排序数组分为很多个run块,通过讲这些run块进行归并排序.最后实现总体排序.每个run块的大小为16-32大小.<br>优化地方: </p>
<ul>
<li>当待排序数组长度小于32就使用二分排序算法</li>
<li>分为多个run块,在通过把run块的起始位置和长度压入栈中,在进行合并.</li>
<li>在找到一个run块的时候会首先判断数组中有序元素的个数.通过二分排序从第一个无序的元素开始排序,加快排序速度</li>
<li>在进行合并的时候会进行”去头”,”去尾”操作,是的归并操作加快速度.</li>
</ul>
<h2 id="sort-T-a-int-lo-int-hi-Comparator-lt-super-T-gt-c-T-work-int-workBase-int-workLen"><a href="#sort-T-a-int-lo-int-hi-Comparator-lt-super-T-gt-c-T-work-int-workBase-int-workLen" class="headerlink" title="sort(T[] a, int lo, int hi, Comparator&lt;? super T&gt; c, T[] work, int workBase, int workLen)"></a>sort(T[] a, int lo, int hi, Comparator&lt;? super T&gt; c, T[] work, int workBase, int workLen)</h2><p>timsort对外的唯一接口.并且只能本包内访问<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">sort</span><span class="hljs-params">(T[] a, <span class="hljs-keyword">int</span> lo, <span class="hljs-keyword">int</span> hi, Comparator&lt;? <span class="hljs-keyword">super</span> T&gt; c,<br>                         T[] work, <span class="hljs-keyword">int</span> workBase, <span class="hljs-keyword">int</span> workLen)</span> </span>&#123;<br>        <span class="hljs-keyword">assert</span> c != <span class="hljs-keyword">null</span> &amp;&amp; a != <span class="hljs-keyword">null</span> &amp;&amp; lo &gt;= <span class="hljs-number">0</span> &amp;&amp; lo &lt;= hi &amp;&amp; hi &lt;= a.length;<br><br>        <span class="hljs-keyword">int</span> nRemaining  = hi - lo;<br>        <span class="hljs-comment">//小于2不用排序,直接返回</span><br>        <span class="hljs-keyword">if</span> (nRemaining &lt; <span class="hljs-number">2</span>) <br>            <span class="hljs-keyword">return</span>; <br>        <span class="hljs-comment">// 看是否小于min_merge,如果小于就直接二分排序,没必要进行复杂的timsort.</span><br>        <span class="hljs-keyword">if</span> (nRemaining &lt; MIN_MERGE) &#123;<br>            <span class="hljs-comment">//下面有详细说明.返回的是从lo开始已经有序的个数,对二分排序用</span><br>            <span class="hljs-keyword">int</span> initRunLen = countRunAndMakeAscending(a, lo, hi, c);<br>            <span class="hljs-comment">// 从第一没有排好序位置开始进行二分排序</span><br>            binarySort(a, lo, hi, lo + initRunLen, c);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//这个时候开始真正的timsort</span><br>        TimSort&lt;T&gt; ts = <span class="hljs-keyword">new</span> TimSort&lt;&gt;(a, c, work, workBase, workLen);<br>        <span class="hljs-comment">//主要将数组分为一个个的minRun,最后在进行合并,如果长度为2的n次幂,minRun为32,否则为16-32之间的数.</span><br>        <span class="hljs-keyword">int</span> minRun = minRunLength(nRemaining);<br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-comment">//再次找到a中已经有序的元素个数</span><br>            <span class="hljs-keyword">int</span> runLen = countRunAndMakeAscending(a, lo, hi, c);<br><br>            <span class="hljs-comment">//如果有序个数小于上面的最小minRun的话,就找到</span><br>            <span class="hljs-keyword">if</span> (runLen &lt; minRun) &#123;<br>                <span class="hljs-keyword">int</span> force = nRemaining &lt;= minRun ? nRemaining : minRun;<br>                binarySort(a, lo, lo + force, lo + runLen, c);<br>                runLen = force;<br>            &#125;<br><br>            <span class="hljs-comment">// 将此run块放入run数组中.</span><br>            ts.pushRun(lo, runLen);<br>            <span class="hljs-comment">//这里之心合并操作.</span><br>            ts.mergeCollapse();<br><br>            <span class="hljs-comment">// Advance to find next run</span><br>            lo += runLen;<br>            nRemaining -= runLen;<br>        &#125; <span class="hljs-keyword">while</span> (nRemaining != <span class="hljs-number">0</span>);<br><br>        <span class="hljs-comment">// Merge all remaining runs to complete sort</span><br>        <span class="hljs-keyword">assert</span> lo == hi;<br>        ts.mergeForceCollapse();<br>        <span class="hljs-keyword">assert</span> ts.stackSize == <span class="hljs-number">1</span>;<br>    &#125;<br></code></pre></td></tr></table></figure></p>
<h2 id="minRunLength"><a href="#minRunLength" class="headerlink" title="minRunLength"></a>minRunLength</h2><p>就是获得一个最小的Run块的大小,大小在16-32之间.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">minRunLength</span><span class="hljs-params">(<span class="hljs-keyword">int</span> n)</span> </span>&#123;<br>    <span class="hljs-keyword">assert</span> n &gt;= <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">int</span> r = <span class="hljs-number">0</span>;      <span class="hljs-comment">// Becomes 1 if any 1 bits are shifted off</span><br>    <span class="hljs-keyword">while</span> (n &gt;= MIN_MERGE) &#123;<br>        r |= (n &amp; <span class="hljs-number">1</span>);<br>        n &gt;&gt;= <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> n + r;<br>&#125;<br></code></pre></td></tr></table></figure></p>
<h2 id="countRunAndMakeAscending-a-lo-hi-c"><a href="#countRunAndMakeAscending-a-lo-hi-c" class="headerlink" title="countRunAndMakeAscending(a, lo, hi, c)"></a>countRunAndMakeAscending(a, lo, hi, c)</h2><p>找到a数组中从lo开始并且已经有序的元素个数,返回已经有序的元素个数.在这里如果逆序在翻转一下,变为有序.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">countRunAndMakeAscending</span><span class="hljs-params">(T[] a, <span class="hljs-keyword">int</span> lo, <span class="hljs-keyword">int</span> hi,<br>                                                    Comparator&lt;? <span class="hljs-keyword">super</span> T&gt; c)</span> </span>&#123;<br>        <span class="hljs-keyword">assert</span> lo &lt; hi;<br>        <span class="hljs-keyword">int</span> runHi = lo + <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">if</span> (runHi == hi)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br>        <span class="hljs-comment">// 找见a从lo开始已经有序的元素个数</span><br>        <span class="hljs-keyword">if</span> (c.compare(a[runHi++], a[lo]) &lt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// Descending</span><br>            <span class="hljs-keyword">while</span> (runHi &lt; hi &amp;&amp; c.compare(a[runHi], a[runHi - <span class="hljs-number">1</span>]) &lt; <span class="hljs-number">0</span>)<br>                runHi++;<br>            reverseRange(a, lo, runHi);<span class="hljs-comment">//如果是逆序则翻转</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;                              <span class="hljs-comment">// Ascending</span><br>            <span class="hljs-keyword">while</span> (runHi &lt; hi &amp;&amp; c.compare(a[runHi], a[runHi - <span class="hljs-number">1</span>]) &gt;= <span class="hljs-number">0</span>)<br>                runHi++;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> runHi - lo;<br>    &#125;<br></code></pre></td></tr></table></figure></p>
<h2 id="binarySort-T-a-int-lo-int-hi-int-start-Comparator-lt-super-T-gt-c"><a href="#binarySort-T-a-int-lo-int-hi-int-start-Comparator-lt-super-T-gt-c" class="headerlink" title="binarySort(T[] a, int lo, int hi, int start,Comparator&lt;? super T&gt; c)"></a>binarySort(T[] a, int lo, int hi, int start,Comparator&lt;? super T&gt; c)</h2><p>此方法就是二分排序,二分排序就是插入排序,但是在寻找向前面插入的位置是通过二分法来查找,然后在插入的.<br>此方法是在a数组中排序从lo到hi的元素,从start开始.</p>
<h2 id="private-void-mergeCollapse"><a href="#private-void-mergeCollapse" class="headerlink" title="private void mergeCollapse()"></a>private void mergeCollapse()</h2><p>这个方法主要是用来合并已经分好的几个Run块的.但是是有条件的;</p>
<ol>
<li>runLen[i - 3] &gt; runLen[i - 2] + runLen[i - 1]</li>
<li>runLen[i - 2] &gt; runLen[i - 1]<br>满足这两个条件才合并,否则什么都不做.<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">mergeCollapse</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">//最少都得有两个块,如果没有,则退出.</span><br>        <span class="hljs-keyword">while</span> (stackSize &gt; <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">int</span> n = stackSize - <span class="hljs-number">2</span>;<span class="hljs-comment">// stackSize为块的数量,-2相当与倒数第二个块</span><br>            <span class="hljs-comment">//如果块的数量大于三个并且倒数第三个Run块大小小于后面两个块的大小和进入</span><br>            <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">0</span> &amp;&amp; runLen[n-<span class="hljs-number">1</span>] &lt;= runLen[n] + runLen[n+<span class="hljs-number">1</span>]) &#123;<br>                <span class="hljs-comment">//如果倒数第三个块比倒一块的大小小,就从倒数第三个块进行合并</span><br>                <span class="hljs-keyword">if</span> (runLen[n - <span class="hljs-number">1</span>] &lt; runLen[n + <span class="hljs-number">1</span>])<br>                    n--;<br>                mergeAt(n);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (runLen[n] &lt;= runLen[n + <span class="hljs-number">1</span>]) &#123;<span class="hljs-comment">//第一个块大小小于第二个块大小,就合并这两个</span><br>                mergeAt(n);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//否则什么都不做    </span><br>                <span class="hljs-keyword">break</span>; <span class="hljs-comment">// Invariant is established</span><br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="private-void-mergeAt-int-i"><a href="#private-void-mergeAt-int-i" class="headerlink" title="private void mergeAt(int i)"></a>private void mergeAt(int i)</h2><p>再来看mergeAt(i)方法,这个方法主要就是合并在run块数组中从i开始的两个块.run[i]和run[i+1]<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">int</span> base1 = runBase[i];<br><span class="hljs-keyword">int</span> len1 = runLen[i];<br><span class="hljs-keyword">int</span> base2 = runBase[i + <span class="hljs-number">1</span>];<br><span class="hljs-keyword">int</span> len2 = runLen[i + <span class="hljs-number">1</span>];<br>runLen[i] = len1 + len2;<br><span class="hljs-comment">//观察如果是倒数第三个块,就倒数第一个块赋值给倒数第二个块</span><br><span class="hljs-keyword">if</span> (i == stackSize - <span class="hljs-number">3</span>) &#123;<br>    runBase[i + <span class="hljs-number">1</span>] = runBase[i + <span class="hljs-number">2</span>];<br>    runLen[i + <span class="hljs-number">1</span>] = runLen[i + <span class="hljs-number">2</span>];<br>&#125;<br>stackSize--;<br><br><span class="hljs-comment">//计算run2的第一个元素能插入到run1的位置</span><br><span class="hljs-comment">//如果属于run1的最后一个位置,就不需要排序,因为run1中的所有元素都比run2中的小,直接返回,</span><br><span class="hljs-comment">//这样可以忽略掉run1中之前的位置</span><br><span class="hljs-keyword">int</span> k = gallopRight(a[base2], a, base1, len1, <span class="hljs-number">0</span>, c);<br><span class="hljs-keyword">assert</span> k &gt;= <span class="hljs-number">0</span>;<br>base1 += k;<br>len1 -= k;<br><span class="hljs-keyword">if</span> (len1 == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span>;<br><br><span class="hljs-comment">//计算run1的最后一个元素在run2中插入的位置,进行去尾.</span><br>len2 = gallopLeft(a[base1 + len1 - <span class="hljs-number">1</span>], a, base2, len2, len2 - <span class="hljs-number">1</span>, c);<br><span class="hljs-keyword">assert</span> len2 &gt;= <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (len2 == <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span>;<br><br><span class="hljs-comment">// 经过上面的“去头”和“去尾”之后，保证run1的开始元素一定大</span><br><span class="hljs-comment">// 于run2的开始元素，并且run1的最后一个数据一定大于run2的最后一个数据  </span><br><span class="hljs-comment">// 然后进行合并,通过两个len的大小找到最好的合并方式</span><br><span class="hljs-keyword">if</span> (len1 &lt;= len2)<br>    mergeLo(base1, len1, base2, len2);<br><span class="hljs-keyword">else</span><br>    mergeHi(base1, len1, base2, len2);<br></code></pre></td></tr></table></figure></p>
<h2 id="private-void-mergeLo-int-base1-int-len1-int-base2-int-len2"><a href="#private-void-mergeLo-int-base1-int-len1-int-base2-int-len2" class="headerlink" title="private void mergeLo(int base1, int len1, int base2, int len2)"></a>private void mergeLo(int base1, int len1, int base2, int len2)</h2><p>mergeLo方法 合并两个run块<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs java">    T[] a = <span class="hljs-keyword">this</span>.a; <span class="hljs-comment">//首先赋值到一个临时数组中</span><br>    T[] tmp = ensureCapacity(len1);<br>    <span class="hljs-keyword">int</span> cursor1 = tmpBase;<br>    <span class="hljs-keyword">int</span> cursor2 = base2;   <span class="hljs-comment">// Indexes int a</span><br>    <span class="hljs-keyword">int</span> dest = base1;      <span class="hljs-comment">// Indexes int a</span><br>    <span class="hljs-comment">//先吧a从base1开始的元素赋值到tmp从tmpbase开始的元素,赋值len1个元素,因为len1肯定是最小的元素</span><br>    System.arraycopy(a, base1, tmp, cursor1, len1);<br><br>    <span class="hljs-comment">// 首先肯定run2的第一个元素小于run1的第一个元素,因为上面都已经去头了</span><br>    a[dest++] = a[cursor2++];<br>    <span class="hljs-keyword">if</span> (--len2 == <span class="hljs-number">0</span>) &#123;<span class="hljs-comment">//如果run2长度为0,则赋值tmp过去,</span><br>        System.arraycopy(tmp, cursor1, a, dest, len1);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (len1 == <span class="hljs-number">1</span>) &#123;<span class="hljs-comment">//如果run1只剩下一个元素,所以只需要先把run2复制过去,再讲Run1的唯一元素赋值过去</span><br>        System.arraycopy(a, cursor2, a, dest, len2);<br>        a[dest + len2] = tmp[cursor1]; <span class="hljs-comment">// Last elt of run 1 to end of merge</span><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    Comparator&lt;? <span class="hljs-keyword">super</span> T&gt; c = <span class="hljs-keyword">this</span>.c;  <span class="hljs-comment">// Use local variable for performance</span><br>    <span class="hljs-keyword">int</span> minGallop = <span class="hljs-keyword">this</span>.minGallop;    <span class="hljs-comment">// 定义一个最小Gallop</span><br>outer: <span class="hljs-comment">//定义跳出什么循环</span><br><br>    <span class="hljs-comment">//在这里有一个思路就是合并两个run,但是会记录两个块中连续个数的数量,如果连续个数的数量大于minGallop也就是7,那就会进入Gallop模式.此模式就是通过"去头","去尾"来减少比较次数</span><br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>        <span class="hljs-keyword">int</span> count1 = <span class="hljs-number">0</span>; <span class="hljs-comment">// Number of times in a row that first run won</span><br>        <span class="hljs-keyword">int</span> count2 = <span class="hljs-number">0</span>; <span class="hljs-comment">// Number of times in a row that second run won</span><br><br>        <span class="hljs-comment">/*<br>         * Do the straightforward thing until (if ever) one run starts<br>         * winning consistently.<br>         */</span><br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-keyword">assert</span> len1 &gt; <span class="hljs-number">1</span> &amp;&amp; len2 &gt; <span class="hljs-number">0</span>;<br>            <span class="hljs-comment">//开始比较</span><br>            <span class="hljs-keyword">if</span> (c.compare(a[cursor2], tmp[cursor1]) &lt; <span class="hljs-number">0</span>) &#123;<br>                a[dest++] = a[cursor2++];<br>                count2++;<br>                count1 = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">if</span> (--len2 == <span class="hljs-number">0</span>)<br>                    <span class="hljs-keyword">break</span> outer;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                a[dest++] = tmp[cursor1++];<br>                count1++;<br>                count2 = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">if</span> (--len1 == <span class="hljs-number">1</span>)<br>                    <span class="hljs-keyword">break</span> outer;<br>            &#125;<br>            <span class="hljs-comment">//当有一个块有连续大于另一个块的次数超过minGallop的时候,进入gallop模式</span><br>        &#125; <span class="hljs-keyword">while</span> ((count1 | count2) &lt; minGallop);<br><br>        <span class="hljs-comment">/*<br>         * One run is winning so consistently that galloping may be a<br>         * huge win. So try that, and continue galloping until (if ever)<br>         * neither run appears to be winning consistently anymore.<br>         */</span><br>        <span class="hljs-keyword">do</span> &#123;<br>            <span class="hljs-keyword">assert</span> len1 &gt; <span class="hljs-number">1</span> &amp;&amp; len2 &gt; <span class="hljs-number">0</span>;<br>            <span class="hljs-comment">//如上,去掉run1的头部</span><br>            count1 = gallopRight(a[cursor2], tmp, cursor1, len1, <span class="hljs-number">0</span>, c);<br>            <span class="hljs-keyword">if</span> (count1 != <span class="hljs-number">0</span>) &#123;<br>                System.arraycopy(tmp, cursor1, a, dest, count1);<br>                dest += count1;<br>                cursor1 += count1;<br>                len1 -= count1;<br>                <span class="hljs-keyword">if</span> (len1 &lt;= <span class="hljs-number">1</span>) <span class="hljs-comment">// len1 == 1 || len1 == 0</span><br>                    <span class="hljs-keyword">break</span> outer;<br>            &#125;<br>            a[dest++] = a[cursor2++];<br>            <span class="hljs-keyword">if</span> (--len2 == <span class="hljs-number">0</span>)<br>                <span class="hljs-keyword">break</span> outer;<br>            <span class="hljs-comment">// 去掉run2的尾部</span><br>            count2 = gallopLeft(tmp[cursor1], a, cursor2, len2, <span class="hljs-number">0</span>, c);<br>            <span class="hljs-keyword">if</span> (count2 != <span class="hljs-number">0</span>) &#123;<br>                System.arraycopy(a, cursor2, a, dest, count2);<br>                dest += count2;<br>                cursor2 += count2;<br>                len2 -= count2;<br>                <span class="hljs-keyword">if</span> (len2 == <span class="hljs-number">0</span>)<br>                    <span class="hljs-keyword">break</span> outer;<br>            &#125;<br>            a[dest++] = tmp[cursor1++];<br>            <span class="hljs-keyword">if</span> (--len1 == <span class="hljs-number">1</span>)<br>                <span class="hljs-keyword">break</span> outer;<br>            minGallop--;<br>            <span class="hljs-comment">//在此模式每多循环一次minGallop减少1</span><br>        &#125; <span class="hljs-keyword">while</span> (count1 &gt;= MIN_GALLOP | count2 &gt;= MIN_GALLOP);<br>        <span class="hljs-keyword">if</span> (minGallop &lt; <span class="hljs-number">0</span>)<br>            minGallop = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">//在离开这个gallop模式后值增加2</span><br>        minGallop += <span class="hljs-number">2</span>;  <span class="hljs-comment">// Penalize for leaving gallop mode</span><br>    &#125;  <span class="hljs-comment">// End of "outer" loop</span><br>    <br>    <span class="hljs-keyword">this</span>.minGallop = minGallop &lt; <span class="hljs-number">1</span> ? <span class="hljs-number">1</span> : minGallop;  <span class="hljs-comment">// Write back to field</span><br>    <span class="hljs-keyword">if</span> (len1 == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">assert</span> len2 &gt; <span class="hljs-number">0</span>;<br>        System.arraycopy(a, cursor2, a, dest, len2);<br>        a[dest + len2] = tmp[cursor1]; <span class="hljs-comment">//  Last elt of run 1 to end of merge</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (len1 == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<br>            <span class="hljs-string">"Comparison method violates its general contract!"</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">assert</span> len2 == <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">assert</span> len1 &gt; <span class="hljs-number">1</span>;<br>        <span class="hljs-comment">//最后将tmp的值赋值到a中</span><br>        System.arraycopy(tmp, cursor1, a, dest, len1);<br>    &#125;<br></code></pre></td></tr></table></figure></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"># java</a>
          
            <a href="/tags/源码/" rel="tag"># 源码</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/01/中断与中断处理/" rel="next" title="中断与中断处理">
                <i class="fa fa-chevron-left"></i> 中断与中断处理
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/06/AQS源码解读/" rel="prev" title="AQS源码解读">
                AQS源码解读 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/image/myavatar.png" alt="fishman">
            
              <p class="site-author-name" itemprop="name">fishman</p>
              <div class="site-description motion-element" itemprop="description"></div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">17</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/1fishman" title="GitHub &rarr; https://github.com/1fishman" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#TimSort"><span class="nav-number">1.</span> <span class="nav-text">TimSort</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#sort-T-a-int-lo-int-hi-Comparator-lt-super-T-gt-c-T-work-int-workBase-int-workLen"><span class="nav-number">1.1.</span> <span class="nav-text">sort(T[] a, int lo, int hi, Comparator&lt;? super T&gt; c, T[] work, int workBase, int workLen)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#minRunLength"><span class="nav-number">1.2.</span> <span class="nav-text">minRunLength</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#countRunAndMakeAscending-a-lo-hi-c"><span class="nav-number">1.3.</span> <span class="nav-text">countRunAndMakeAscending(a, lo, hi, c)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#binarySort-T-a-int-lo-int-hi-int-start-Comparator-lt-super-T-gt-c"><span class="nav-number">1.4.</span> <span class="nav-text">binarySort(T[] a, int lo, int hi, int start,Comparator&lt;? super T&gt; c)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#private-void-mergeCollapse"><span class="nav-number">1.5.</span> <span class="nav-text">private void mergeCollapse()</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#private-void-mergeAt-int-i"><span class="nav-number">1.6.</span> <span class="nav-text">private void mergeAt(int i)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#private-void-mergeLo-int-base1-int-len1-int-base2-int-len2"><span class="nav-number">1.7.</span> <span class="nav-text">private void mergeLo(int base1, int len1, int base2, int len2)</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fishman</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.1.0</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="Total Visitors">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="Total Views">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/affix.js?v=7.1.0"></script>

  <script src="/js/schemes/pisces.js?v=7.1.0"></script>



  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  
<script>
  $('.highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('Copy');
      }, 300);
    }).append(e);
  })
</script>


  

  

</body>
</html>
